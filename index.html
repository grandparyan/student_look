<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任務接收系統</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 簡單的載入中動畫 */
        .spinner {
            border-top-color: theme('colors.indigo.500');
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- ===== 1. 登入畫面 ===== -->
        <div id="login-view">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">任務系統登入</h1>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">帳號</label>
                        <input type="text" id="username" name="username" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                        <input type="password" id="password" name="password" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" id="login-button" 
                            class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        登入
                    </button>
                </form>
                <div id="login-message" class="mt-4 text-center text-red-600 font-medium"></div>
            </div>
        </div>

        <!-- ===== 2. 任務列表畫面 (預設隱藏) ===== -->
        <div id="tasks-view" class="hidden">
            <!-- 頂部導覽列 -->
            <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-lg">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">待處理任務</h1>
                    <p id="welcome-user" class="text-sm text-gray-600">載入中...</p>
                </div>
                <div>
                    <button id="refresh-button" class_alias="mr-2" title="重新整理"
                            class="p-2 rounded-full text-gray-600 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                        <!-- 重新整理 SVG Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101A7.002 7.002 0 0110 3c3.866 0 7 3.134 7 7s-3.134 7-7 7-7-3.134-7-7a1 1 0 011-1h2a1 1 0 011 1 3 3 0 003 3 3 3 0 003-3 1 1 0 112 0 5 5 0 01-5 5 5 5 0 01-5-5 1 1 0 011-1V3a1 1 0 01-1-1V2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button id="logout-button" 
                            class="bg-red-500 text-white py-2 px-4 rounded-md font-semibold text-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                        登出
                    </button>
                </div>
            </div>

            <!-- 任務列表容器 -->
            <div id="task-message" class="text-center text-red-600 font-medium mb-4"></div>
            <div id="task-list" class="space-y-4">
                <!-- 任務卡片將會動態插入此處 -->
                
                <!-- 載入中指示 -->
                <div id="loading-spinner" class="text-center py-10">
                    <div class="spinner w-8 h-8 border-4 border-gray-200 rounded-full mx-auto"></div>
                    <p class="mt-2 text-gray-600">正在載入任務...</p>
                </div>
            </div>
        </div>

    </div> <!-- /#app -->


    <script>
        // ----------------------------------------------------
        // JavaScript 邏輯
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {

            // --- API 伺服器位置 ---
            // 假設 HTML 和 API 在同一個伺服器上
            const API_BASE_URL = ''; 

            // --- 全域狀態變數 ---
            let currentToken = null;
            let currentUser = null; // { username: "...", full_name: "..." }

            // --- DOM 元素 ---
            const loginView = document.getElementById('login-view');
            const tasksView = document.getElementById('tasks-view');
            const loginForm = document.getElementById('login-form');
            const loginButton = document.getElementById('login-button');
            const loginMessage = document.getElementById('login-message');

            const welcomeUser = document.getElementById('welcome-user');
            const logoutButton = document.getElementById('logout-button');
            const refreshButton = document.getElementById('refresh-button');
            const taskList = document.getElementById('task-list');
            const taskMessage = document.getElementById('task-message');
            const loadingSpinner = document.getElementById('loading-spinner');

            // --- 1. 處理登入 ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginMessage.textContent = '';
                loginButton.disabled = true;
                loginButton.textContent = '登入中...';

                // FastAPI 的 OAuth2PasswordRequestForm 預期的是 form-data，而非 JSON
                const formData = new FormData();
                formData.append('username', document.getElementById('username').value);
                formData.append('password', document.getElementById('password').value);

                try {
                    const response = await fetch(`${API_BASE_URL}/token`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.detail || '登入失敗');
                    }

                    // 登入成功
                    currentToken = data.access_token;
                    await fetchCurrentUser(); // 獲取使用者資訊
                    updateUI('tasks');        // 切換到任務畫面
                    fetchTasks();             // 獲取任務列表

                } catch (error) {
                    loginMessage.textContent = error.message;
                } finally {
                    loginButton.disabled = false;
                    loginButton.textContent = '登入';
                }
            });

            // --- 2. 處理登出 ---
            logoutButton.addEventListener('click', () => {
                currentToken = null;
                currentUser = null;
                updateUI('login');
                taskList.innerHTML = ''; // 清空任務列表
                loginForm.reset();
            });

            // --- 3. 獲取當前使用者資訊 ---
            async function fetchCurrentUser() {
                if (!currentToken) return;
                try {
                    const response = await fetch(`${API_BASE_URL}/users/me`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    if (!response.ok) throw new Error('無法獲取使用者資訊');
                    
                    currentUser = await response.json();
                    welcomeUser.textContent = `你好, ${currentUser.full_name}`;

                } catch (error) {
                    console.error(error);
                    welcomeUser.textContent = '你好, 訪客';
                }
            }

            // --- 4. 獲取任務列表 ---
            refreshButton.addEventListener('click', fetchTasks);
            
            async function fetchTasks() {
                if (!currentToken) return;

                loadingSpinner.style.display = 'block';
                taskList.innerHTML = ''; // 清空舊列表
                taskMessage.textContent = '';

                try {
                    const response = await fetch(`${API_BASE_URL}/tasks`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });

                    if (response.status === 401) {
                        // Token 過期或無效
                        alert('您的登入已過期，請重新登入。');
                        handleLogout();
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('無法載入任務列表');
                    }

                    const tasks = await response.json();
                    renderTasks(tasks);

                } catch (error) {
                    taskMessage.textContent = error.message;
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            // --- 5. 渲染任務列表 ---
            function renderTasks(tasks) {
                taskList.innerHTML = ''; // 再次清空
                if (tasks.length === 0) {
                    taskList.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center text-gray-600">
                                            <p class="font-semibold text-lg">太棒了！</p>
                                            <p>目前沒有 '待處理' 的任務。</p>
                                          </div>`;
                    return;
                }

                tasks.forEach(task => {
                    const isAlreadyAccepted = currentUser ? task.accepted_by.includes(currentUser.full_name) : false;
                    const peopleNeeded = task.required_count - task.accepted_by.length;
                    
                    let buttonHtml = '';
                    if (task.is_full) {
                        buttonHtml = `<button disabled class="w-full sm:w-auto bg-gray-400 text-white py-2 px-5 rounded-md font-semibold text-sm cursor-not-allowed">已額滿</button>`;
                    } else if (isAlreadyAccepted) {
                        buttonHtml = `<button disabled class="w-full sm:w-auto bg-green-500 text-white py-2 px-5 rounded-md font-semibold text-sm cursor-not-allowed">已接取</button>`;
                    } else {
                        buttonHtml = `<button data-row-id="${task.row_number}" 
                                              class="accept-task-btn w-full sm:w-auto bg-indigo-600 text-white py-2 px-5 rounded-md font-semibold text-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                        接取任務
                                      </button>`;
                    }

                    const taskCard = `
                        <div class="bg-white p-5 rounded-lg shadow-md border-l-4 ${task.is_full ? 'border-gray-300' : 'border-indigo-500'}">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                <!-- 任務資訊 -->
                                <div class="mb-4 sm:mb-0">
                                    <p class="text-sm text-gray-500">${task.timestamp} (由 ${task.reporter} 回報)</p>
                                    <h2 class="text-lg font-bold text-gray-900">${task.location}</h2>
                                    <p class="text-gray-700">${task.description}</p>
                                </div>
                                
                                <!-- 狀態與按鈕 -->
                                <div class="flex flex-col items-start sm:items-end space-y-2">
                                    <div class="text-right">
                                        <p class="text-sm font-semibold ${peopleNeeded > 0 ? 'text-indigo-600' : 'text-gray-600'}">
                                            ${task.is_full ? '人數已滿' : `尚缺 ${peopleNeeded} 人`}
                                            <span class="text-xs text-gray-500 font-normal">(${task.accepted_by.length} / ${task.required_count})</span>
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            ${task.accepted_by.length > 0 ? '接取者: ' + task.accepted_by.join(', ') : '尚無人接取'}
                                        </p>
                                    </div>
                                    ${buttonHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    taskList.insertAdjacentHTML('beforeend', taskCard);
                });
            }

            // --- 6. 處理接取任務 (使用事件委派) ---
            taskList.addEventListener('click', async (e) => {
                if (!e.target.matches('.accept-task-btn')) {
                    return; // 點擊的不是 "接取任務" 按鈕
                }

                const button = e.target;
                const rowId = button.dataset.rowId;

                button.disabled = true;
                button.textContent = '處理中...';
                taskMessage.textContent = '';

                try {
                    const response = await fetch(`${API_BASE_URL}/accept-task/${rowId}`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${currentToken}`,
                            'Content-Type': 'application/json' 
                        }
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.detail || '接取失敗');
                    }

                    // 接取成功！
                    taskMessage.textContent = result.message || '任務接取成功！';
                    taskMessage.className = 'text-center text-green-600 font-medium mb-4';
                    
                    // 重新整理任務列表
                    fetchTasks(); 

                } catch (error) {
                    console.error('接取任務失敗:', error);
                    taskMessage.textContent = `錯誤: ${error.message}`;
                    taskMessage.className = 'text-center text-red-600 font-medium mb-4';
                    button.disabled = false; // 讓使用者可以重試
                    button.textContent = '接取任務';
                }
            });


            // --- 7. 更新 UI 畫面 (登入/任務) ---
            function updateUI(view) {
                if (view === 'tasks') {
                    loginView.classList.add('hidden');
                    tasksView.classList.remove('hidden');
                } else {
                    // 'login'
                    loginView.classList.remove('hidden');
                    tasksView.classList.add('hidden');
                }
            }

            // --- 初始啟動 ---
            updateUI('login'); // 預設顯示登入畫面
        });
    </script>
</body>
</html>
